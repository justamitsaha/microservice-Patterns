# =========================================
# ğŸš€ Basic Application Settings
# =========================================
# Logical service name used by:
#   - Eureka (for registration & discovery)
#   - Config Server (to fetch config)
#   - Spring Cloud Bus (for distributed refresh)
spring.application.name=customer-service

# Local port on which this service runs.
# In container platforms, override via ENV variable.
server.port=8081


# =========================================
# ğŸ—„ï¸ Database (R2DBC + MySQL)
# =========================================
# Reactive (non-blocking) DB connection.
spring.r2dbc.url=r2dbc:mysql://localhost:3306/amit?serverTimezone=Asia/Kolkata
spring.r2dbc.username=root
spring.r2dbc.password=shamit2020


# =========================================
# ğŸ”— Service-to-Service URLs
# =========================================
# Base URL for invoking Order Service.
# Uses Eureka service name ("order-service") instead of hardcoding IP/Port.
app.order-service.base-url=http://order-service


# =========================================
# ğŸ“Š Management, Metrics & Observability
# =========================================
# Exposes important Actuator endpoints for monitoring & debugging.
management.endpoints.web.exposure.include=health,info,metrics,prometheus,refresh,busrefresh,circuitbreakers,circuitbreakerevents,retry,retryevents,bulkheads,bulkheadevents

# Configure HTTP request percentile + SLO metrics for performance dashboards.
management.metrics.distribution.percentiles.http.server.requests=0.5,0.9,0.95,0.99
management.metrics.distribution.slo.http.server.requests=100ms,250ms,500ms,1s,2s

# === âœ… Distributed Tracing (OpenTelemetry) ===
# Trace sampling â€” 1.0 = trace every request. Reduce to ~0.1 in PROD.
management.tracing.sampling.probability=1.0

# OTLP endpoint for sending trace data (Tempo, Jaeger, etc.)
management.tracing.export.otlp.endpoint=http://192.168.0.143:4318/v1/traces


# === ğŸ§µ Spring Cloud Bus (Kafka) ===
# Used for distributed configuration refresh.
spring.kafka.bootstrap-servers=192.168.0.143:9092,192.168.0.143:9093,192.168.0.143:9094


# =========================================
# ğŸ’ª Resilience4j Configuration (Fault Tolerance)
# =========================================
# Applied for WebClient call to Order Service:
# âœ… Circuit Breaker â€“ stop calls to unstable service
# âœ… Retry â€“ only for transient network issues
# âœ… Bulkhead â€“ limit concurrent calls for protection
# âŒ TimeoutException removed from retry (fast fallback behavior)


# --- ğŸ”¥ Circuit Breaker ---
# Opens if 50%+ of last 6 calls fail, then stops calling for 10s.
resilience4j.circuitbreaker.instances.orderService.slidingWindowType=COUNT_BASED
resilience4j.circuitbreaker.instances.orderService.slidingWindowSize=6
resilience4j.circuitbreaker.instances.orderService.minimumNumberOfCalls=3
resilience4j.circuitbreaker.instances.orderService.failureRateThreshold=50
resilience4j.circuitbreaker.instances.orderService.waitDurationInOpenState=10s
resilience4j.circuitbreaker.instances.orderService.automaticTransitionFromOpenToHalfOpenEnabled=true
resilience4j.circuitbreaker.instances.orderService.permittedNumberOfCallsInHalfOpenState=2

# Exceptions counted as failures by the Circuit Breaker
resilience4j.circuitbreaker.instances.orderService.recordExceptions= \
  org.springframework.web.reactive.function.client.WebClientRequestException, \
  org.springframework.web.reactive.function.client.WebClientResponseException, \
  java.util.concurrent.TimeoutException


# --- ğŸ” Retry ---
# Retries ONLY for transient network failures (NOT for slow responses/timeouts).
resilience4j.retry.instances.orderService.maxAttempts=2
resilience4j.retry.instances.orderService.waitDuration=100ms

# Retry only on connectivity issues (not on timeouts or 5xx)
resilience4j.retry.instances.orderService.retryExceptions= \
  org.springframework.web.reactive.function.client.WebClientRequestException


# --- ğŸš§ Bulkhead ---
# Limits concurrent calls to prevent overload or thread starvation.
resilience4j.bulkhead.instances.orderService.maxConcurrentCalls=20
resilience4j.bulkhead.instances.orderService.maxWaitDuration=200ms


# --- â± Time Limiter ---
# Max allowed call duration. Reactor's .timeout() handles logic,
# but this enables metrics visibility on Actuator.
resilience4j.timelimiter.instances.orderService.timeoutDuration=2s
resilience4j.timelimiter.instances.orderService.cancelRunningFuture=false


# =========================================
# ğŸŒ Eureka Discovery Configuration
# =========================================
# Registers this service with Eureka Discovery Server.
eureka.client.service-url.defaultZone=http://localhost:8761/eureka
eureka.instance.prefer-ip-address=true


# =========================================
# ğŸ“˜ Swagger / OpenAPI
# =========================================
springdoc.swagger-ui.path=/swagger-ui/index.html
